# Common environment variables for all workflows
# These can be overridden by API calls with dynamic values
# Proper handling of API data with null/default values for optional fields
environment: &default_env
  flutter: stable
  xcode: latest
  cocoapods: default
  vars:
    # App Configuration - Required from API
    VERSION_NAME: "${VERSION_NAME}"
    VERSION_CODE: "${VERSION_CODE}"
    APP_NAME: "${APP_NAME}"
    ORG_NAME: "${ORG_NAME}"
    WEB_URL: "${WEB_URL}"
    PKG_NAME: "${PKG_NAME}"
    BUNDLE_ID: "${BUNDLE_ID}"
    EMAIL_ID: "${EMAIL_ID}"

    # Feature Flags - API configurable with proper defaults
    PUSH_NOTIFY: "${PUSH_NOTIFY}"
    IS_CHATBOT: "${IS_CHATBOT}"
    IS_DEEPLINK: "${IS_DEEPLINK}"
    IS_SPLASH: "${IS_SPLASH}"
    IS_PULLDOWN: "${IS_PULLDOWN}"
    IS_BOTTOMMENU: "${IS_BOTTOMMENU}"
    IS_LOAD_IND: "${IS_LOAD_IND}"

    # Permissions - API configurable with secure defaults (all false unless specified)
    IS_CAMERA: "${IS_CAMERA}"
    IS_LOCATION: "${IS_LOCATION}"
    IS_MIC: "${IS_MIC}"
    IS_NOTIFICATION: "${IS_NOTIFICATION}"
    IS_CONTACT: "${IS_CONTACT}"
    IS_BIOMETRIC: "${IS_BIOMETRIC}"
    IS_CALENDAR: "${IS_CALENDAR}"
    IS_STORAGE: "${IS_STORAGE}"

    # Assets - API configurable with empty defaults for optional fields
    LOGO_URL: "${LOGO_URL}"
    SPLASH: "${SPLASH}"
    SPLASH_BG: "${SPLASH_BG}"
    SPLASH_BG_COLOR: "${SPLASH_BG_COLOR}"
    SPLASH_TAGLINE: "${SPLASH_TAGLINE}"
    SPLASH_TAGLINE_COLOR: "${SPLASH_TAGLINE_COLOR}"
    SPLASH_ANIMATION: "${SPLASH_ANIMATION}"
    SPLASH_DURATION: "${SPLASH_DURATION}"

    # Bottom Menu Configuration - API configurable with empty defaults
    BOTTOMMENU_ITEMS: "${BOTTOMMENU_ITEMS}"
    BOTTOMMENU_BG_COLOR: "${BOTTOMMENU_BG_COLOR}"
    BOTTOMMENU_ICON_COLOR: "${BOTTOMMENU_ICON_COLOR}"
    BOTTOMMENU_TEXT_COLOR: "${BOTTOMMENU_TEXT_COLOR}"
    BOTTOMMENU_FONT: "${BOTTOMMENU_FONT}"
    BOTTOMMENU_FONT_SIZE: "${BOTTOMMENU_FONT_SIZE}"
    BOTTOMMENU_FONT_BOLD: "${BOTTOMMENU_FONT_BOLD}"
    BOTTOMMENU_FONT_ITALIC: "${BOTTOMMENU_FONT_ITALIC}"
    BOTTOMMENU_ACTIVE_TAB_COLOR: "${BOTTOMMENU_ACTIVE_TAB_COLOR}"
    BOTTOMMENU_ICON_POSITION: "${BOTTOMMENU_ICON_POSITION}"
    BOTTOMMENU_VISIBLE_ON: "${BOTTOMMENU_VISIBLE_ON}"

    # Firebase Configuration - API required for push notifications
    firebase_config_android: "${firebase_config_android}"
    firebase_config_ios: "${firebase_config_ios}"

    # iOS Configuration - API required for iOS builds
    APPLE_TEAM_ID: "${APPLE_TEAM_ID}"
    APNS_KEY_ID: "${APNS_KEY_ID}"
    APNS_AUTH_KEY_URL: "${APNS_AUTH_KEY_URL}"
    CERT_PASSWORD: "${CERT_PASSWORD}"
    PROFILE_URL: "${PROFILE_URL}"
    CERT_CER_URL: "${CERT_CER_URL}"
    CERT_KEY_URL: "${CERT_KEY_URL}"
    APP_STORE_CONNECT_KEY_IDENTIFIER: "${APP_STORE_CONNECT_KEY_IDENTIFIER}"
    IPHONEOS_DEPLOYMENT_TARGET: "${IPHONEOS_DEPLOYMENT_TARGET}"
    COCOAPODS_PLATFORM: "${COCOAPODS_PLATFORM}"
    EXPORT_METHOD: "${EXPORT_METHOD}"
    IS_DEVELOPMENT_PROFILE: "${IS_DEVELOPMENT_PROFILE}"
    IS_PRODUCTION_PROFILE: "${IS_PRODUCTION_PROFILE}"

    # Android Configuration - API required for Android builds
    KEY_STORE: "${KEY_STORE}"
    CM_KEYSTORE_PASSWORD: "${CM_KEYSTORE_PASSWORD}"
    CM_KEY_ALIAS: "${CM_KEY_ALIAS}"
    CM_KEY_PASSWORD: "${CM_KEY_PASSWORD}"
    COMPILE_SDK_VERSION: "${COMPILE_SDK_VERSION}"
    MIN_SDK_VERSION: "${MIN_SDK_VERSION}"
    TARGET_SDK_VERSION: "${TARGET_SDK_VERSION}"

    # iOS Permissions - API configurable with defaults
    IS_PHOTO_LIBRARY: "${IS_PHOTO_LIBRARY}"
    IS_PHOTO_LIBRARY_ADD: "${IS_PHOTO_LIBRARY_ADD}"
    IS_FACE_ID: "${IS_FACE_ID}"
    IS_TOUCH_ID: "${IS_TOUCH_ID}"

    # Email Configuration - Optional with defaults
    SMTP_SERVER: "${SMTP_SERVER}"
    SMTP_PORT: "${SMTP_PORT}"
    SMTP_USERNAME: "${SMTP_USERNAME}"
    SMTP_PASSWORD: "${SMTP_PASSWORD}"

scripts:
  - &debug_env
    name: Debug Environment Variables
    script: |
      #!/usr/bin/env bash
      set -e
      echo "üîç Debugging environment variables..."

      # Function to safely print sensitive variables
      print_var() {
        local var_name=$1
        local var_value=${!var_name}
        if [[ $var_name == *"PASSWORD"* ]] || [[ $var_name == *"KEY"* ]]; then
          echo "$var_name: [REDACTED]"
        else
          echo "$var_name: $var_value"
        fi
      }

      echo "*********** App Name & Version ***********"
      print_var "APP_NAME"
      print_var "ORG_NAME"
      print_var "WEB_URL"
      print_var "VERSION_NAME"
      print_var "VERSION_CODE"
      print_var "PKG_NAME"
      print_var "BUNDLE_ID"

      echo "*********** App Customization Configuration ***********"
      print_var "IS_SPLASH"
      print_var "IS_PULLDOWN"
      print_var "IS_LOAD_IND"
      print_var "IS_BOTTOMMENU"
      print_var "IS_DEEPLINK"

      echo "*********** Push Notification Configuration ***********"
      print_var "PUSH_NOTIFY"
      print_var "IS_CHATBOT"

      echo "*********** Android Configuration ***********"
      print_var "KEY_STORE"
      print_var "CM_KEYSTORE_PASSWORD"
      print_var "CM_KEY_ALIAS"
      print_var "CM_KEY_PASSWORD"
      print_var "COMPILE_SDK_VERSION"
      print_var "MIN_SDK_VERSION"
      print_var "TARGET_SDK_VERSION"

      echo "*********** iOS Configuration ***********"
      print_var "APP_STORE_CONNECT_KEY_IDENTIFIER"
      print_var "APNS_KEY_ID"
      print_var "APPLE_TEAM_ID"
      print_var "APNS_AUTH_KEY_URL"
      print_var "IPHONEOS_DEPLOYMENT_TARGET"
      print_var "EXPORT_METHOD"

      echo "*********** Firebase Configuration ***********"
      print_var "firebase_config_android"
      print_var "firebase_config_ios"

      echo "*********** Splash Configuration ***********"
      print_var "SPLASH"
      print_var "SPLASH_BG"
      print_var "SPLASH_BG_COLOR"
      print_var "SPLASH_TAGLINE"
      print_var "SPLASH_TAGLINE_COLOR"
      print_var "SPLASH_ANIMATION"
      print_var "SPLASH_DURATION"

      echo "*********** Bottom Navigation Configuration ***********"
      print_var "BOTTOMMENU_ITEMS"
      print_var "BOTTOMMENU_BG_COLOR"
      print_var "BOTTOMMENU_ICON_COLOR"
      print_var "BOTTOMMENU_TEXT_COLOR"
      print_var "BOTTOMMENU_FONT"
      print_var "BOTTOMMENU_FONT_SIZE"
      print_var "BOTTOMMENU_FONT_BOLD"
      print_var "BOTTOMMENU_FONT_ITALIC"
      print_var "BOTTOMMENU_ACTIVE_TAB_COLOR"
      print_var "BOTTOMMENU_ICON_POSITION"
      print_var "BOTTOMMENU_VISIBLE_ON"

      echo "*********** Permissions ***********"
      print_var "IS_CAMERA"
      print_var "IS_LOCATION"
      print_var "IS_MIC"
      print_var "IS_NOTIFICATION"
      print_var "IS_CONTACT"
      print_var "IS_BIOMETRIC"
      print_var "IS_CALENDAR"
      print_var "IS_STORAGE"
      print_var "IS_PHOTO_LIBRARY"
      print_var "IS_PHOTO_LIBRARY_ADD"
      print_var "IS_FACE_ID"
      print_var "IS_TOUCH_ID"

      echo "*********** Email Configuration ***********"
      print_var "EMAIL_ID"
      print_var "SMTP_SERVER"
      print_var "SMTP_PORT"
      print_var "SMTP_USERNAME"
      print_var "SMTP_PASSWORD"

      echo "‚úÖ Environment variables debug complete"

workflows:
  android-publish:
    name: Android Publish
    environment: *default_env
    scripts:
      - name: Force Gradle Wrapper Version
        script: |
          cat > android/gradle/wrapper/gradle-wrapper.properties <<EOF
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.12-all.zip
          EOF
          echo "‚úÖ Forced gradle-wrapper.properties to Gradle 8.12"
      - *debug_env
      - name: Get Flutter packages
        script: flutter pub get
      - name: Initialize Android Gradle Wrapper
        script: |
          #!/usr/bin/env bash
          set -e
          echo "üîß Initializing Android Gradle Wrapper for compatibility..."

          cd android

          # Check Java availability
          echo "üîç Checking Java installation..."
          if ! command -v java >/dev/null 2>&1; then
              echo "‚ùå Java is not installed or not in PATH"
              exit 1
          fi

          JAVA_VERSION=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}')
          echo "‚úÖ Java version: $JAVA_VERSION"

          # Create gradle wrapper directory if it doesn't exist
          mkdir -p gradle/wrapper

          # Download gradle-wrapper.jar
          echo "üì• Downloading gradle-wrapper.jar..."
          curl -o gradle/wrapper/gradle-wrapper.jar https://raw.githubusercontent.com/gradle/gradle/v8.12.0/gradle/wrapper/gradle-wrapper.jar

          # Create gradle-wrapper.properties
          echo "üìù Creating gradle-wrapper.properties..."
          cat > gradle/wrapper/gradle-wrapper.properties <<EOF
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.12-bin.zip
          networkTimeout=10000
          validateDistributionUrl=true
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF

          # Make gradlew executable
          chmod +x gradlew

          # Verify the wrapper setup
          echo "üîç Verifying Gradle wrapper setup..."
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
              echo "‚ùå gradle-wrapper.jar not found"
              exit 1
          fi

          if [ ! -f "gradle/wrapper/gradle-wrapper.properties" ]; then
              echo "‚ùå gradle-wrapper.properties not found"
              exit 1
          fi

          echo "‚úÖ Gradle wrapper initialization complete"
      - name: Validate Android Project Structure
        script: |
          #!/usr/bin/env bash
          set -e
          echo "üîç Validating Android project structure..."

          # Check critical Android files
          REQUIRED_FILES=(
              "android/app/build.gradle"
              "android/build.gradle"
              "android/gradle.properties"
              "android/settings.gradle"
          )

          for file in "${REQUIRED_FILES[@]}"; do
              if [ ! -f "$file" ]; then
                  echo "‚ùå Missing required file: $file"
                  exit 1
              else
                  echo "‚úÖ Found: $file"
              fi
          done

          # Ensure Android SDK versions are compatible
          echo "üîß Checking Android SDK compatibility for API 35..."

          # Check if build.gradle has proper compileSdkVersion
          if grep -q "compileSdkVersion.*3[5-9]" android/app/build.gradle; then
              echo "‚úÖ Compatible compileSdkVersion found"
          else
              echo "‚ö†Ô∏è  May need compileSdkVersion update for Android 15"
          fi

          echo "‚úÖ Android project structure validated"
      - name: Run Android build script
        script: |
          #!/usr/bin/env bash
          set -e
          echo "üöÄ Running Android build using comprehensive script system..."

          # Set workflow name for email notifications
          export WORKFLOW_NAME="Android Publish"

          # Check if we have the comprehensive Android main.sh script
          if [ -f "lib/scripts/android/main.sh" ]; then
              echo "üéØ Using comprehensive Android main.sh script..."
              chmod +x lib/scripts/android/main.sh
              ./lib/scripts/android/main.sh
          else
              echo "‚ö†Ô∏è  Android main.sh not found, using enhanced fallback build process..."
              
              # Enhanced Fallback: Set up Android code signing
              echo "üîê Setting up Android code signing..."
              if [ -n "$KEY_STORE" ]; then
                  echo "üì• Downloading keystore..."
                  wget -O android/app/keystore.jks "$KEY_STORE"
                  cat > android/key.properties << EOF
          storePassword=$CM_KEYSTORE_PASSWORD
          keyPassword=$CM_KEY_PASSWORD
          keyAlias=$CM_KEY_ALIAS
          storeFile=keystore.jks
          EOF
                  echo "‚úÖ Keystore configured"
              fi
              
              # Build APK and AAB with comprehensive error handling
              echo "üèóÔ∏è Building Android APK and AAB..."
              
              # Build APK with retry mechanism
              echo "üì± Building APK..."
              if ! flutter build apk --release \
                --dart-define=PKG_NAME="$PKG_NAME" \
                --dart-define=APP_NAME="$APP_NAME" \
                --dart-define=ORG_NAME="$ORG_NAME" \
                --dart-define=VERSION_NAME="$VERSION_NAME" \
                --dart-define=VERSION_CODE="$VERSION_CODE" \
                --dart-define=PUSH_NOTIFY="$PUSH_NOTIFY" \
                --dart-define=firebase_config_android="$firebase_config_android" \
                --dart-define=WEB_URL="$WEB_URL" \
                --dart-define=IS_SPLASH="$IS_SPLASH" \
                --dart-define=SPLASH="$SPLASH" \
                --dart-define=SPLASH_ANIMATION="$SPLASH_ANIMATION" \
                --dart-define=SPLASH_BG_COLOR="$SPLASH_BG_COLOR" \
                --dart-define=SPLASH_TAGLINE="$SPLASH_TAGLINE" \
                --dart-define=SPLASH_TAGLINE_COLOR="$SPLASH_TAGLINE_COLOR" \
                --dart-define=SPLASH_DURATION="$SPLASH_DURATION" \
                --dart-define=IS_PULLDOWN="$IS_PULLDOWN" \
                --dart-define=LOGO_URL="$LOGO_URL" \
                --dart-define=IS_BOTTOMMENU="$IS_BOTTOMMENU" \
                --dart-define=BOTTOMMENU_ITEMS="$BOTTOMMENU_ITEMS" \
                --dart-define=IS_DEEPLINK="$IS_DEEPLINK" \
                --dart-define=IS_LOAD_IND="$IS_LOAD_IND" \
                --dart-define=IS_CHATBOT="$IS_CHATBOT" \
                --dart-define=IS_CAMERA="$IS_CAMERA" \
                --dart-define=IS_LOCATION="$IS_LOCATION" \
                --dart-define=IS_BIOMETRIC="$IS_BIOMETRIC" \
                --dart-define=IS_MIC="$IS_MIC" \
                --dart-define=IS_CONTACT="$IS_CONTACT" \
                --dart-define=IS_CALENDAR="$IS_CALENDAR" \
                --dart-define=IS_NOTIFICATION="$IS_NOTIFICATION" \
                --dart-define=IS_STORAGE="$IS_STORAGE"; then
                
                echo "‚ùå APK build failed, trying with clean..."
                flutter clean
                flutter pub get
                
                flutter build apk --release \
                  --dart-define=PKG_NAME="$PKG_NAME" \
                  --dart-define=APP_NAME="$APP_NAME" \
                  --dart-define=VERSION_NAME="$VERSION_NAME" \
                  --dart-define=VERSION_CODE="$VERSION_CODE" \
                  --dart-define=PUSH_NOTIFY="$PUSH_NOTIFY"
              fi
              
              # Build AAB
              echo "üì¶ Building AAB..."
              flutter build appbundle --release \
                --dart-define=PKG_NAME="$PKG_NAME" \
                --dart-define=APP_NAME="$APP_NAME" \
                --dart-define=ORG_NAME="$ORG_NAME" \
                --dart-define=VERSION_NAME="$VERSION_NAME" \
                --dart-define=VERSION_CODE="$VERSION_CODE" \
                --dart-define=PUSH_NOTIFY="$PUSH_NOTIFY" \
                --dart-define=firebase_config_android="$firebase_config_android" \
                --dart-define=WEB_URL="$WEB_URL" \
                --dart-define=IS_SPLASH="$IS_SPLASH" \
                --dart-define=SPLASH="$SPLASH" \
                --dart-define=SPLASH_ANIMATION="$SPLASH_ANIMATION" \
                --dart-define=SPLASH_BG_COLOR="$SPLASH_BG_COLOR" \
                --dart-define=SPLASH_TAGLINE="$SPLASH_TAGLINE" \
                --dart-define=SPLASH_TAGLINE_COLOR="$SPLASH_TAGLINE_COLOR" \
                --dart-define=SPLASH_DURATION="$SPLASH_DURATION" \
                --dart-define=IS_PULLDOWN="$IS_PULLDOWN" \
                --dart-define=LOGO_URL="$LOGO_URL" \
                --dart-define=IS_BOTTOMMENU="$IS_BOTTOMMENU" \
                --dart-define=BOTTOMMENU_ITEMS="$BOTTOMMENU_ITEMS" \
                --dart-define=IS_DEEPLINK="$IS_DEEPLINK" \
                --dart-define=IS_LOAD_IND="$IS_LOAD_IND" \
                --dart-define=IS_CHATBOT="$IS_CHATBOT" \
                --dart-define=IS_CAMERA="$IS_CAMERA" \
                --dart-define=IS_LOCATION="$IS_LOCATION" \
                --dart-define=IS_BIOMETRIC="$IS_BIOMETRIC" \
                --dart-define=IS_MIC="$IS_MIC" \
                --dart-define=IS_CONTACT="$IS_CONTACT" \
                --dart-define=IS_CALENDAR="$IS_CALENDAR" \
                --dart-define=IS_NOTIFICATION="$IS_NOTIFICATION" \
                --dart-define=IS_STORAGE="$IS_STORAGE"
              
              # Move outputs
              echo "üìÅ Moving build outputs..."
              mkdir -p output
              
              # Check for APK
              if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
                  cp build/app/outputs/flutter-apk/app-release.apk output/
                  echo "‚úÖ APK moved to output/"
              else
                  echo "‚ö†Ô∏è  APK not found at expected location"
                  find build/ -name "*.apk" -type f | head -5
              fi
              
              # Check for AAB
              if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
                  cp build/app/outputs/bundle/release/app-release.aab output/
                  echo "‚úÖ AAB moved to output/"
              else
                  echo "‚ö†Ô∏è  AAB not found at expected location"
                  find build/ -name "*.aab" -type f | head -5
              fi
              
              echo "üìã Final output contents:"
              ls -la output/ || echo "No output directory"
          fi
      - name: Send success notification
        script: |
          #!/usr/bin/env bash
          set -e
          echo "üìß Sending success notification..."

          if [ -f "lib/scripts/email_notification.py" ] && [ -n "$SMTP_USERNAME" ] && [ -n "$SMTP_PASSWORD" ]; then
              chmod +x lib/scripts/email_notification.py
              python3 lib/scripts/email_notification.py success
              echo "‚úÖ Success notification sent"
          else
              echo "‚ÑπÔ∏è  Email notification skipped (script not found or email not configured)"
          fi
    artifacts:
      - build/app/outputs/flutter-apk/app-release.apk
      - build/app/outputs/bundle/release/app-release.aab
      - output/
    publishing:
      email:
        recipients:
          - $EMAIL_ID
        notify:
          success: false
          failure: false

  ios-publish:
    name: iOS Publish
    environment: *default_env
    scripts:
      - name: Force Gradle Wrapper Version
        script: |
          cat > android/gradle/wrapper/gradle-wrapper.properties <<EOF
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.12-all.zip
          EOF
          echo "‚úÖ Forced gradle-wrapper.properties to Gradle 8.12"
      - *debug_env
      - name: Get Flutter packages
        script: flutter pub get
      - name: Validate iOS Environment
        script: |
          #!/usr/bin/env bash
          set -e
          echo "üîç Validating iOS build environment..."

          # Check Xcode version compatibility
          XCODE_VERSION=$(xcodebuild -version | grep "Xcode" | awk '{print $2}')
          echo "üì± Xcode Version: $XCODE_VERSION"

          # Check iOS Simulator availability
          echo "üì± Available iOS Simulators:"
          xcrun simctl list devices ios | grep -E "(iPhone|iPad)" | head -3

          # Check required iOS files
          REQUIRED_IOS_FILES=(
              "ios/Runner.xcodeproj/project.pbxproj"
              "ios/Runner/Info.plist"
              "ios/Podfile"
          )

          for file in "${REQUIRED_IOS_FILES[@]}"; do
              if [ ! -f "$file" ]; then
                  echo "‚ùå Missing required iOS file: $file"
                  exit 1
              else
                  echo "‚úÖ Found: $file"
              fi
          done

          # Check iOS deployment target
          if grep -q "IPHONEOS_DEPLOYMENT_TARGET.*13\|14\|15\|16\|17" ios/Runner.xcodeproj/project.pbxproj; then
              echo "‚úÖ Compatible iOS deployment target found"
          else
              echo "‚ö†Ô∏è  iOS deployment target may need update for latest iOS versions"
          fi

          echo "‚úÖ iOS environment validated"
      - name: Setup iOS Dependencies
        script: |
          #!/usr/bin/env bash
          set -e
          echo "üì¶ Setting up iOS dependencies with enhanced compatibility..."

          cd ios

          # Ensure Podfile exists and is properly configured
          if [ ! -f "Podfile" ]; then
              echo "‚ö†Ô∏è  Podfile not found, creating optimized version..."
              cat > Podfile << EOF
          platform :ios, '$IPHONEOS_DEPLOYMENT_TARGET'
          use_frameworks! :linkage => :static

          ENV['COCOAPODS_DISABLE_STATS'] = 'true'

          project 'Runner', {
            'Debug' => :debug,
            'Profile' => :release,
            'Release' => :release,
          }

          def flutter_root
            generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
            unless File.exist?(generated_xcode_build_settings_path)
              raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure flutter pub get is executed first"
            end

            File.foreach(generated_xcode_build_settings_path) do |line|
              matches = line.match(/FLUTTER_ROOT\\=(.*)/)
              return matches[1].strip if matches
            end
            raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Generated.xcconfig, then run flutter pub get"
          end

          require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

          flutter_ios_podfile_setup

          target 'Runner' do
            use_frameworks!
            use_modular_headers!

            flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
          end

          post_install do |installer|
            installer.pods_project.targets.each do |target|
              flutter_additional_ios_build_settings(target)
              target.build_configurations.each do |config|
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '$IPHONEOS_DEPLOYMENT_TARGET'
                config.build_settings['ENABLE_BITCODE'] = 'NO'
                config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64' if config.build_settings['SDKROOT'] == 'iphoneos'
              end
            end
          end
          EOF
              echo "‚úÖ Created optimized Podfile"
          else
              # Update existing Podfile deployment target
              if grep -q "platform :ios" Podfile; then
                  sed -i.bak "s/platform :ios, '[^']*'/platform :ios, '$IPHONEOS_DEPLOYMENT_TARGET'/" Podfile
                  echo "‚úÖ Updated platform to iOS $IPHONEOS_DEPLOYMENT_TARGET"
              fi
          fi

          # Clean and install pods with retry mechanism
          echo "üßπ Cleaning previous CocoaPods installation..."
          rm -rf Pods/ Podfile.lock

          echo "üì¶ Installing CocoaPods dependencies..."

          # Retry mechanism for pod install
          for i in {1..3}; do
              if pod install --repo-update; then
                  echo "‚úÖ CocoaPods installation successful"
                  break
              else
                  echo "‚ö†Ô∏è  Pod install attempt $i failed"
                  if [ $i -eq 3 ]; then
                      echo "‚ùå Pod install failed after 3 attempts"
                      exit 1
                  fi
                  echo "üîÑ Retrying in 10 seconds..."
                  sleep 10
              fi
          done

          cd ..
          echo "‚úÖ iOS dependencies setup complete"
      - name: Run iOS build script
        script: |
          #!/usr/bin/env bash
          set -e
          echo "üöÄ Running iOS build using comprehensive script system..."

          # Set workflow name for email notifications
          export WORKFLOW_NAME="iOS Publish"

          # Source environment variables from export.sh first
          if [ -f "lib/scripts/ios/export.sh" ]; then
              echo "üìã Sourcing iOS environment variables..."
              source lib/scripts/ios/export.sh
          fi

          # Check if we have the comprehensive iOS main.sh script
          if [ -f "lib/scripts/ios/main.sh" ]; then
              echo "üéØ Using comprehensive iOS main.sh script..."
              # Set workflow name for email notifications
              export WORKFLOW_NAME="Combined Android & iOS Build"
              chmod +x lib/scripts/ios/main.sh
              ./lib/scripts/ios/main.sh
          else
              echo "‚ö†Ô∏è  iOS main.sh not found, using enhanced fallback build process..."
              
              # Enhanced iOS code signing setup
              echo "üîê Setting up iOS code signing..."
              KEYCHAIN_NAME="build.keychain"
              KEYCHAIN_PASSWORD="temporary"

              # Create keychain with better error handling
              if ! security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"; then
                  echo "‚ö†Ô∏è  Keychain creation failed, trying with cleanup..."
                  security delete-keychain "$KEYCHAIN_NAME" || true
                  security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
              fi
              
              security default-keychain -s "$KEYCHAIN_NAME"
              security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
              security set-keychain-settings -t 3600 -u "$KEYCHAIN_NAME"

              # Download and setup certificates with validation
              if [ -n "$CERT_CER_URL" ] && [ -n "$CERT_KEY_URL" ]; then
                  echo "üì• Downloading certificates..."
                  
                  if wget -O ios/distribution.cer "$CERT_CER_URL" && wget -O ios/privatekey.key "$CERT_KEY_URL"; then
                      echo "‚úÖ Certificates downloaded"
                      
                      # Convert to P12 with error handling
                      if openssl pkcs12 -export -out ios/certificate.p12 -inkey ios/privatekey.key -in ios/distribution.cer -password pass:"$CERT_PASSWORD"; then
                          echo "‚úÖ P12 certificate created"
                          
                          # Import certificate
                          if security import ios/certificate.p12 -k "$KEYCHAIN_NAME" -P "$CERT_PASSWORD" -T /usr/bin/codesign; then
                              security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
                              echo "‚úÖ Certificate imported successfully"
                          else
                              echo "‚ö†Ô∏è  Certificate import failed, continuing without code signing"
                          fi
                      else
                          echo "‚ö†Ô∏è  P12 conversion failed, continuing without code signing"
                      fi
                  else
                      echo "‚ö†Ô∏è  Certificate download failed, continuing without code signing"
                  fi
              fi

              # Setup provisioning profile
              if [ -n "$PROFILE_URL" ]; then
                  echo "üì• Downloading provisioning profile..."
                  if wget -O ios/profile.mobileprovision "$PROFILE_URL"; then
                      mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
                      
                      # Extract profile info with error handling
                      PROFILE_PLIST=$(mktemp)
                      if security cms -D -i ios/profile.mobileprovision > "$PROFILE_PLIST"; then
                          UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" "$PROFILE_PLIST" 2>/dev/null || echo "")
                          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c "Print Name" "$PROFILE_PLIST" 2>/dev/null || echo "")
                          
                          if [ -n "$UUID" ] && [ -n "$PROFILE_NAME" ]; then
                              cp ios/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/"$UUID".mobileprovision
                              echo "PROFILE_NAME=$PROFILE_NAME" >> $CM_ENV
                              echo "PROFILE_UUID=$UUID" >> $CM_ENV
                              echo "‚úÖ Provisioning profile installed: $PROFILE_NAME"
                          else
                              echo "‚ö†Ô∏è  Could not extract profile info, continuing..."
                          fi
                      else
                          echo "‚ö†Ô∏è  Profile parsing failed, continuing..."
                      fi
                      rm -f "$PROFILE_PLIST"
                  else
                      echo "‚ö†Ô∏è  Profile download failed, continuing..."
                  fi
              fi

              # Create ExportOptions.plist with better defaults
              cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>$EXPORT_METHOD</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>$APPLE_TEAM_ID</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>$BUNDLE_ID</key>
              <string>\${PROFILE_NAME:-match AppStore $BUNDLE_ID}</string>
            </dict>
            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
          </dict>
          </plist>
          EOF

              # Build iOS with comprehensive dart-define and error handling
              echo "üèóÔ∏è Building iOS app..."
              
              if ! flutter build ios --release --no-codesign \
                --dart-define=PKG_NAME="$PKG_NAME" \
                --dart-define=BUNDLE_ID="$BUNDLE_ID" \
                --dart-define=APP_NAME="$APP_NAME" \
                --dart-define=ORG_NAME="$ORG_NAME" \
                --dart-define=VERSION_NAME="$VERSION_NAME" \
                --dart-define=VERSION_CODE="$VERSION_CODE" \
                --dart-define=PUSH_NOTIFY="$PUSH_NOTIFY" \
                --dart-define=firebase_config_ios="$firebase_config_ios" \
                --dart-define=WEB_URL="$WEB_URL" \
                --dart-define=IS_SPLASH="$IS_SPLASH" \
                --dart-define=SPLASH="$SPLASH" \
                --dart-define=SPLASH_ANIMATION="$SPLASH_ANIMATION" \
                --dart-define=SPLASH_BG_COLOR="$SPLASH_BG_COLOR" \
                --dart-define=SPLASH_TAGLINE="$SPLASH_TAGLINE" \
                --dart-define=SPLASH_TAGLINE_COLOR="$SPLASH_TAGLINE_COLOR" \
                --dart-define=SPLASH_DURATION="$SPLASH_DURATION" \
                --dart-define=IS_PULLDOWN="$IS_PULLDOWN" \
                --dart-define=LOGO_URL="$LOGO_URL" \
                --dart-define=IS_BOTTOMMENU="$IS_BOTTOMMENU" \
                --dart-define=BOTTOMMENU_ITEMS="$BOTTOMMENU_ITEMS" \
                --dart-define=BOTTOMMENU_BG_COLOR="$BOTTOMMENU_BG_COLOR" \
                --dart-define=BOTTOMMENU_ICON_COLOR="$BOTTOMMENU_ICON_COLOR" \
                --dart-define=BOTTOMMENU_TEXT_COLOR="$BOTTOMMENU_TEXT_COLOR" \
                --dart-define=BOTTOMMENU_FONT="$BOTTOMMENU_FONT" \
                --dart-define=BOTTOMMENU_FONT_SIZE="$BOTTOMMENU_FONT_SIZE" \
                --dart-define=BOTTOMMENU_FONT_BOLD="$BOTTOMMENU_FONT_BOLD" \
                --dart-define=BOTTOMMENU_FONT_ITALIC="$BOTTOMMENU_FONT_ITALIC" \
                --dart-define=BOTTOMMENU_ACTIVE_TAB_COLOR="$BOTTOMMENU_ACTIVE_TAB_COLOR" \
                --dart-define=BOTTOMMENU_ICON_POSITION="$BOTTOMMENU_ICON_POSITION" \
                --dart-define=BOTTOMMENU_VISIBLE_ON="$BOTTOMMENU_VISIBLE_ON" \
                --dart-define=IS_DEEPLINK="$IS_DEEPLINK" \
                --dart-define=IS_LOAD_IND="$IS_LOAD_IND" \
                --dart-define=IS_CHATBOT="$IS_CHATBOT" \
                --dart-define=IS_CAMERA="$IS_CAMERA" \
                --dart-define=IS_LOCATION="$IS_LOCATION" \
                --dart-define=IS_BIOMETRIC="$IS_BIOMETRIC" \
                --dart-define=IS_MIC="$IS_MIC" \
                --dart-define=IS_CONTACT="$IS_CONTACT" \
                --dart-define=IS_CALENDAR="$IS_CALENDAR" \
                --dart-define=IS_NOTIFICATION="$IS_NOTIFICATION" \
                --dart-define=IS_STORAGE="$IS_STORAGE" \
                --dart-define=IS_PHOTO_LIBRARY="$IS_PHOTO_LIBRARY" \
                --dart-define=IS_PHOTO_LIBRARY_ADD="$IS_PHOTO_LIBRARY_ADD" \
                --dart-define=IS_FACE_ID="$IS_FACE_ID" \
                --dart-define=IS_TOUCH_ID="$IS_TOUCH_ID"; then
                
                echo "‚ùå iOS build failed, trying with clean..."
                flutter clean
                cd ios && pod install && cd ..
                flutter pub get
                
                # Retry with minimal configuration
                flutter build ios --release --no-codesign \
                  --dart-define=BUNDLE_ID="$BUNDLE_ID" \
                  --dart-define=APP_NAME="$APP_NAME" \
                  --dart-define=VERSION_NAME="$VERSION_NAME" \
                  --dart-define=VERSION_CODE="$VERSION_CODE"
              fi

              # Archive and export IPA with better error handling
              echo "üì¶ Archiving and exporting IPA..."
              
              # Load environment variables for profile info
              source $CM_ENV 2>/dev/null || true
              
              # Archive with error handling
              echo "üèóÔ∏è Creating Xcode archive..."
              if xcodebuild -workspace ios/Runner.xcworkspace \
                -scheme Runner \
                -configuration Release \
                -archivePath build/ios/archive/Runner.xcarchive \
                clean archive \
                CODE_SIGN_STYLE=Manual \
                DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
                PROVISIONING_PROFILE_SPECIFIER="${PROFILE_NAME:-}" \
                PROVISIONING_PROFILE="${PROFILE_UUID:-}" \
                PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
                CODE_SIGN_IDENTITY="Apple Distribution" \
                IPHONEOS_DEPLOYMENT_TARGET="$IPHONEOS_DEPLOYMENT_TARGET" \
                OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_NAME"; then
                
                echo "‚úÖ Archive created successfully"
                
                # Export IPA
                echo "üì¶ Exporting IPA..."
                if xcodebuild -exportArchive \
                  -archivePath build/ios/archive/Runner.xcarchive \
                  -exportPath build/ios/ipa \
                  -exportOptionsPlist ExportOptions.plist; then
                  
                  echo "‚úÖ IPA exported successfully"
                else
                  echo "‚ö†Ô∏è  IPA export failed, but archive was created"
                fi
              else
                echo "‚ùå Archive creation failed"
                echo "üìã Available build products:"
                find build/ -name "*.app" -type d | head -5
              fi

              # Copy artifacts to output folder
              echo "üìÅ Moving iOS artifacts..."
              mkdir -p output
              
              if [ -f "build/ios/ipa/Runner.ipa" ]; then
                  cp build/ios/ipa/Runner.ipa output/
                  echo "‚úÖ IPA moved to output/"
              else
                  echo "‚ö†Ô∏è  IPA not found, checking for .app files..."
                  find build/ -name "*.app" -type d | head -1 | xargs -I {} cp -r {} output/ 2>/dev/null || true
              fi
              
              # Cleanup keychain
              security delete-keychain "$KEYCHAIN_NAME" || true
              
              echo "üìã Final iOS output contents:"
              ls -la output/ || echo "No output directory"
          fi
      - name: Send success notification
        script: |
          #!/usr/bin/env bash
          set -e
          echo "üìß Sending success notification..."

          if [ -f "lib/scripts/email_notification.py" ] && [ -n "$SMTP_USERNAME" ] && [ -n "$SMTP_PASSWORD" ]; then
              chmod +x lib/scripts/email_notification.py
              python3 lib/scripts/email_notification.py success
              echo "‚úÖ Success notification sent"
          else
              echo "‚ÑπÔ∏è  Email notification skipped (script not found or email not configured)"
          fi
    artifacts:
      - build/ios/ipa/Runner.ipa
      - build/ios/archive/Runner.xcarchive
      - output/
    publishing:
      email:
        recipients:
          - $EMAIL_ID
        notify:
          success: false
          failure: false

  combined-workflow:
    name: Combined Android & iOS Build
    max_build_duration: 120
    instance_type: mac_mini_m2
    environment:
      flutter: stable
      xcode: latest
      node: v18.17.0
      java: 17
      groups:
        - google_credentials
        - appstore_credentials
      vars:
        # App Configuration - Required from API
        VERSION_NAME: "${VERSION_NAME}"
        VERSION_CODE: "${VERSION_CODE}"
        APP_NAME: "${APP_NAME}"
        ORG_NAME: "${ORG_NAME}"
        WEB_URL: "${WEB_URL}"
        PKG_NAME: "${PKG_NAME}"
        BUNDLE_ID: "${BUNDLE_ID}"
        EMAIL_ID: "${EMAIL_ID}"

        # Feature Flags - API configurable
        PUSH_NOTIFY: "${PUSH_NOTIFY}"
        IS_CHATBOT: "${IS_CHATBOT}"
        IS_DEEPLINK: "${IS_DEEPLINK}"
        IS_SPLASH: "${IS_SPLASH}"
        IS_PULLDOWN: "${IS_PULLDOWN}"
        IS_BOTTOMMENU: "${IS_BOTTOMMENU}"
        IS_LOAD_IND: "${IS_LOAD_IND}"

        # Permissions - API configurable
        IS_CAMERA: "${IS_CAMERA}"
        IS_LOCATION: "${IS_LOCATION}"
        IS_MIC: "${IS_MIC}"
        IS_NOTIFICATION: "${IS_NOTIFICATION}"
        IS_CONTACT: "${IS_CONTACT}"
        IS_BIOMETRIC: "${IS_BIOMETRIC}"
        IS_CALENDAR: "${IS_CALENDAR}"
        IS_STORAGE: "${IS_STORAGE}"

        # Assets - API configurable
        LOGO_URL: "${LOGO_URL}"
        SPLASH: "${SPLASH}"
        SPLASH_BG: "${SPLASH_BG}"
        SPLASH_BG_COLOR: "${SPLASH_BG_COLOR}"
        SPLASH_TAGLINE: "${SPLASH_TAGLINE}"
        SPLASH_TAGLINE_COLOR: "${SPLASH_TAGLINE_COLOR}"
        SPLASH_ANIMATION: "${SPLASH_ANIMATION}"
        SPLASH_DURATION: "${SPLASH_DURATION}"

        # Bottom Menu Configuration - API configurable
        BOTTOMMENU_ITEMS: "${BOTTOMMENU_ITEMS}"
        BOTTOMMENU_BG_COLOR: "${BOTTOMMENU_BG_COLOR}"
        BOTTOMMENU_ICON_COLOR: "${BOTTOMMENU_ICON_COLOR}"
        BOTTOMMENU_TEXT_COLOR: "${BOTTOMMENU_TEXT_COLOR}"
        BOTTOMMENU_FONT: "${BOTTOMMENU_FONT}"
        BOTTOMMENU_FONT_SIZE: "${BOTTOMMENU_FONT_SIZE}"
        BOTTOMMENU_FONT_BOLD: "${BOTTOMMENU_FONT_BOLD}"
        BOTTOMMENU_FONT_ITALIC: "${BOTTOMMENU_FONT_ITALIC}"
        BOTTOMMENU_ACTIVE_TAB_COLOR: "${BOTTOMMENU_ACTIVE_TAB_COLOR}"
        BOTTOMMENU_ICON_POSITION: "${BOTTOMMENU_ICON_POSITION}"
        BOTTOMMENU_VISIBLE_ON: "${BOTTOMMENU_VISIBLE_ON}"

        # Firebase Configuration - API required for push notifications
        firebase_config_android: "${firebase_config_android}"
        firebase_config_ios: "${firebase_config_ios}"

        # iOS Configuration - API required for iOS builds
        APPLE_TEAM_ID: "${APPLE_TEAM_ID}"
        APNS_KEY_ID: "${APNS_KEY_ID}"
        APNS_AUTH_KEY_URL: "${APNS_AUTH_KEY_URL}"
        CERT_PASSWORD: "${CERT_PASSWORD}"
        PROFILE_URL: "${PROFILE_URL}"
        CERT_CER_URL: "${CERT_CER_URL}"
        CERT_KEY_URL: "${CERT_KEY_URL}"
        APP_STORE_CONNECT_KEY_IDENTIFIER: "${APP_STORE_CONNECT_KEY_IDENTIFIER}"
        IPHONEOS_DEPLOYMENT_TARGET: "${IPHONEOS_DEPLOYMENT_TARGET}"
        COCOAPODS_PLATFORM: "${COCOAPODS_PLATFORM}"
        EXPORT_METHOD: "${EXPORT_METHOD}"
        IS_DEVELOPMENT_PROFILE: "${IS_DEVELOPMENT_PROFILE}"
        IS_PRODUCTION_PROFILE: "${IS_PRODUCTION_PROFILE}"

        # Android Configuration - API required for Android builds
        KEY_STORE: "${KEY_STORE}"
        CM_KEYSTORE_PASSWORD: "${CM_KEYSTORE_PASSWORD}"
        CM_KEY_ALIAS: "${CM_KEY_ALIAS}"
        CM_KEY_PASSWORD: "${CM_KEY_PASSWORD}"
        COMPILE_SDK_VERSION: "${COMPILE_SDK_VERSION}"
        MIN_SDK_VERSION: "${MIN_SDK_VERSION}"
        TARGET_SDK_VERSION: "${TARGET_SDK_VERSION}"

        # iOS Permissions - API configurable
        IS_PHOTO_LIBRARY: "${IS_PHOTO_LIBRARY}"
        IS_PHOTO_LIBRARY_ADD: "${IS_PHOTO_LIBRARY_ADD}"
        IS_FACE_ID: "${IS_FACE_ID}"
        IS_TOUCH_ID: "${IS_TOUCH_ID}"

        # Email Configuration - Optional with defaults
        SMTP_SERVER: "${SMTP_SERVER}"
        SMTP_PORT: "${SMTP_PORT}"
        SMTP_USERNAME: "${SMTP_USERNAME}"
        SMTP_PASSWORD: "${SMTP_PASSWORD}"
    scripts:
      - name: Initialize Gradle Wrapper
        script: |
          echo "üîß Initializing Gradle wrapper..."

          # Create Gradle wrapper directory
          mkdir -p android/gradle/wrapper

          # Download Gradle wrapper JAR
          curl -L -o android/gradle/wrapper/gradle-wrapper.jar https://raw.githubusercontent.com/gradle/gradle/v8.12.0/gradle/wrapper/gradle-wrapper.jar

          # Create gradle-wrapper.properties
          cat > android/gradle/wrapper/gradle-wrapper.properties << EOL
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.12-all.zip
          EOL

          # Create gradlew script
          cat > android/gradlew << EOL
          #!/bin/sh
          exec java -cp android/gradle/wrapper/gradle-wrapper.jar org.gradle.wrapper.GradleWrapperMain "\$@"
          EOL

          # Make gradlew executable
          chmod +x android/gradlew

          # Verify Gradle wrapper
          ./android/gradlew --version

          echo "‚úÖ Gradle wrapper initialized"
      - name: Get Flutter packages
        script: flutter pub get
      - name: Build Android (Using main.sh)
        script: |
          #!/usr/bin/env bash
          set -e
          echo "ü§ñ Building Android using comprehensive script system..."

          # Set workflow name for email notifications
          export WORKFLOW_NAME="Combined Android & iOS Build"

          # Check if we have the comprehensive Android main.sh script
          if [ -f "lib/scripts/android/main.sh" ]; then
              echo "üéØ Using comprehensive Android main.sh script..."
              chmod +x lib/scripts/android/main.sh
              ./lib/scripts/android/main.sh
          else
              echo "‚ö†Ô∏è  Android main.sh not found, using enhanced fallback..."
              
              # Validate Android project structure
              echo "üîç Validating Android project..."
              REQUIRED_FILES=(
                  "android/app/build.gradle"
                  "android/build.gradle"
                  "android/gradle.properties"
                  "android/settings.gradle"
              )
              
              for file in "${REQUIRED_FILES[@]}"; do
                  if [ ! -f "$file" ]; then
                      echo "‚ùå Missing required Android file: $file"
                      exit 1
                  fi
              done
              
              # Enhanced Android setup and build
              if [ -n "$KEY_STORE" ]; then
                  echo "üîê Setting up Android keystore..."
                  wget -O android/app/keystore.jks "$KEY_STORE"
                  cat > android/key.properties << EOF
          storePassword=$CM_KEYSTORE_PASSWORD
          keyPassword=$CM_KEY_PASSWORD
          keyAlias=$CM_KEY_ALIAS
          storeFile=keystore.jks
          EOF
                  echo "‚úÖ Android keystore configured"
              fi
              
              echo "üèóÔ∏è Building Android APK and AAB..."
              
              # Build with retry mechanism
              if ! flutter build apk --release \
                --dart-define=PKG_NAME="$PKG_NAME" \
                --dart-define=APP_NAME="$APP_NAME" \
                --dart-define=VERSION_NAME="$VERSION_NAME" \
                --dart-define=VERSION_CODE="$VERSION_CODE" \
                --dart-define=PUSH_NOTIFY="$PUSH_NOTIFY" \
                --dart-define=WEB_URL="$WEB_URL" \
                --dart-define=IS_SPLASH="$IS_SPLASH" \
                --dart-define=SPLASH="$SPLASH" \
                --dart-define=IS_BOTTOMMENU="$IS_BOTTOMMENU" \
                --dart-define=BOTTOMMENU_ITEMS="$BOTTOMMENU_ITEMS"; then
                
                echo "‚ùå Android APK build failed, retrying with clean..."
                flutter clean
                flutter pub get
                flutter build apk --release \
                  --dart-define=PKG_NAME="$PKG_NAME" \
                  --dart-define=APP_NAME="$APP_NAME" \
                  --dart-define=VERSION_NAME="$VERSION_NAME" \
                  --dart-define=VERSION_CODE="$VERSION_CODE" \
                  --dart-define=PUSH_NOTIFY="$PUSH_NOTIFY"
              fi
              
              flutter build appbundle --release \
                --dart-define=PKG_NAME="$PKG_NAME" \
                --dart-define=APP_NAME="$APP_NAME" \
                --dart-define=VERSION_NAME="$VERSION_NAME" \
                --dart-define=VERSION_CODE="$VERSION_CODE" \
                --dart-define=PUSH_NOTIFY="$PUSH_NOTIFY" \
                --dart-define=WEB_URL="$WEB_URL" \
                --dart-define=IS_SPLASH="$IS_SPLASH" \
                --dart-define=SPLASH="$SPLASH" \
                --dart-define=IS_BOTTOMMENU="$IS_BOTTOMMENU" \
                --dart-define=BOTTOMMENU_ITEMS="$BOTTOMMENU_ITEMS"
              
              echo "‚úÖ Android builds completed"
          fi
      - name: Setup iOS Dependencies
        script: |
          #!/usr/bin/env bash
          set -e
          echo "üì¶ Setting up iOS dependencies for combined build..."

          cd ios

          # Create or update Podfile
          if [ ! -f "Podfile" ]; then
              echo "üìÑ Creating optimized Podfile..."
              cat > Podfile << EOF
          platform :ios, '$IPHONEOS_DEPLOYMENT_TARGET'
          use_frameworks! :linkage => :static

          ENV['COCOAPODS_DISABLE_STATS'] = 'true'

          def flutter_root
            generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
            unless File.exist?(generated_xcode_build_settings_path)
              raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure flutter pub get is executed first"
            end

            File.foreach(generated_xcode_build_settings_path) do |line|
              matches = line.match(/FLUTTER_ROOT\\=(.*)/)
              return matches[1].strip if matches
            end
            raise "FLUTTER_ROOT not found"
          end

          require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

          flutter_ios_podfile_setup

          target 'Runner' do
            use_frameworks!
            use_modular_headers!
            flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
          end

          post_install do |installer|
            installer.pods_project.targets.each do |target|
              flutter_additional_ios_build_settings(target)
              target.build_configurations.each do |config|
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '$IPHONEOS_DEPLOYMENT_TARGET'
                config.build_settings['ENABLE_BITCODE'] = 'NO'
              end
            end
          end
          EOF
          fi

          # Clean and install with retry
          echo "üßπ Cleaning iOS dependencies..."
          rm -rf Pods/ Podfile.lock

          echo "üì¶ Installing iOS dependencies..."
          for i in {1..2}; do
              if pod install --repo-update; then
                  echo "‚úÖ iOS dependencies installed successfully"
                  break
              else
                  if [ $i -eq 2 ]; then
                      echo "‚ùå Pod install failed, but continuing..."
                      break
                  fi
                  echo "üîÑ Retrying pod install..."
                  sleep 5
              fi
          done

          cd ..
      - name: Build iOS (Using main.sh)
        script: |
          #!/usr/bin/env bash
          set -e
          echo "üçé Building iOS using comprehensive script system..."

          # Source environment variables from export.sh first
          if [ -f "lib/scripts/ios/export.sh" ]; then
              echo "üìã Sourcing iOS environment variables..."
              source lib/scripts/ios/export.sh
          fi

          # Check if we have the comprehensive iOS main.sh script
          if [ -f "lib/scripts/ios/main.sh" ]; then
              echo "üéØ Using comprehensive iOS main.sh script..."
              # Set workflow name for email notifications
              export WORKFLOW_NAME="Combined Android & iOS Build"
              chmod +x lib/scripts/ios/main.sh
              ./lib/scripts/ios/main.sh
          else
              echo "‚ö†Ô∏è  iOS main.sh not found, using streamlined fallback..."
              
              # Streamlined iOS build for combined workflow
              echo "üèóÔ∏è Building iOS app..."
              
              if ! flutter build ios --release --no-codesign \
                --dart-define=BUNDLE_ID="$BUNDLE_ID" \
                --dart-define=APP_NAME="$APP_NAME" \
                --dart-define=VERSION_NAME="$VERSION_NAME" \
                --dart-define=VERSION_CODE="$VERSION_CODE" \
                --dart-define=PUSH_NOTIFY="$PUSH_NOTIFY" \
                --dart-define=WEB_URL="$WEB_URL" \
                --dart-define=IS_SPLASH="$IS_SPLASH" \
                --dart-define=SPLASH="$SPLASH" \
                --dart-define=IS_BOTTOMMENU="$IS_BOTTOMMENU" \
                --dart-define=BOTTOMMENU_ITEMS="$BOTTOMMENU_ITEMS"; then
                
                echo "‚ùå iOS build failed, retrying with minimal config..."
                flutter clean
                cd ios && pod install && cd ..
                flutter pub get
                
                flutter build ios --release --no-codesign \
                  --dart-define=BUNDLE_ID="$BUNDLE_ID" \
                  --dart-define=APP_NAME="$APP_NAME" \
                  --dart-define=VERSION_NAME="$VERSION_NAME" \
                  --dart-define=VERSION_CODE="$VERSION_CODE"
              fi
              
              echo "‚úÖ iOS build completed"
          fi
      - name: Copy all artifacts to output folder
        script: |
          #!/usr/bin/env bash
          set -e
          echo "üìÅ Collecting all build artifacts..."

          # Create output directory
          mkdir -p output

          # Copy Android artifacts with validation
          echo "ü§ñ Checking Android artifacts..."
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
              cp build/app/outputs/flutter-apk/app-release.apk output/
              echo "‚úÖ Android APK copied to output/"
          else
              echo "‚ö†Ô∏è  Android APK not found at expected location"
              find build/ -name "*.apk" -type f | head -3
          fi

          if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
              cp build/app/outputs/bundle/release/app-release.aab output/
              echo "‚úÖ Android AAB copied to output/"
          else
              echo "‚ö†Ô∏è  Android AAB not found at expected location"
              find build/ -name "*.aab" -type f | head -3
          fi

          # Copy iOS artifacts with validation
          echo "üçé Checking iOS artifacts..."
          if [ -f "build/ios/ipa/Runner.ipa" ]; then
              cp build/ios/ipa/Runner.ipa output/
              echo "‚úÖ iOS IPA copied to output/"
          else
              echo "‚ö†Ô∏è  iOS IPA not found, checking for alternatives..."
              # Look for .app files as fallback
              APP_FILE=$(find build/ -name "*.app" -type d | head -1)
              if [ -n "$APP_FILE" ]; then
                  cp -r "$APP_FILE" output/
                  echo "‚úÖ iOS .app copied to output/"
              else
                  echo "‚ö†Ô∏è  No iOS artifacts found"
              fi
          fi

          echo "üìã Final Build Summary:"
          echo "======================="
          if [ -d "output" ]; then
              ls -la output/
              echo ""
              echo "üì± Android Files:"
              ls output/*.apk 2>/dev/null && echo "  ‚úÖ APK found" || echo "  ‚ùå APK missing"
              ls output/*.aab 2>/dev/null && echo "  ‚úÖ AAB found" || echo "  ‚ùå AAB missing"
              echo "üçé iOS Files:"
              ls output/*.ipa 2>/dev/null && echo "  ‚úÖ IPA found" || echo "  ‚ùå IPA missing"
              ls output/*.app 2>/dev/null && echo "  ‚úÖ APP found" || echo "  ‚ùå APP missing"
          else
              echo "‚ùå No output directory created"
          fi
      - name: Send success notification
        script: |
          #!/usr/bin/env bash
          set -e
          echo "üìß Sending combined build success notification..."

          if [ -f "lib/scripts/email_notification.py" ] && [ -n "$SMTP_USERNAME" ] && [ -n "$SMTP_PASSWORD" ]; then
              chmod +x lib/scripts/email_notification.py
              python3 lib/scripts/email_notification.py success
              echo "‚úÖ Success notification sent for combined build"
          else
              echo "‚ÑπÔ∏è  Email notification skipped (script not found or email not configured)"
          fi
    artifacts:
      - build/app/outputs/flutter-apk/app-release.apk
      - build/app/outputs/bundle/release/app-release.aab
      - build/ios/ipa/Runner.ipa
      - build/ios/archive/Runner.xcarchive
      - output/
    publishing:
      email:
        recipients:
          - $EMAIL_ID
        notify:
          success: false
          failure: false
